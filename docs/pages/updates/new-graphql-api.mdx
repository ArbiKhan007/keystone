import { Markdown, getServerSideProps } from '../../components/Markdown';

# A Fresh New GraphQL API

As we move closer to releasing Keyston 6 in General Availability, we're taking this opportunity to make a collection of changes to our GraphQL API.
Our GraphQL API has had very few changes since we introduced it in Keystone 5, but we decided there were a few things we could tighten and tidy before releasing Keystone 6.

This guide will walk you through the changes that we've made, why we made them, and what you will need to change in your code to use them.

### Example Schema

To help illustrate the changes we will refer to the following example schema, taken from the [Task Manager](https://github.com/keystonejs/keystone/tree/master/examples/task-manager) example project.

```
export const lists = createSchema({
  Task: list({
    fields: {
      label: text({ isRequired: true }),
      priority: select({
        dataType: 'enum',
        options: [
          { label: 'Low', value: 'low' },
          { label: 'Medium', value: 'medium' },
          { label: 'High', value: 'high' },
        ],
      }),
      isComplete: checkbox(),
      assignedTo: relationship({ ref: 'Person.tasks', many: false }),
      finishBy: timestamp(),
    },
  }),
  Person: list({
    fields: {
      name: text({ isRequired: true }),
      tasks: relationship({ ref: 'Task.assignedTo', many: true }),
    },
  }),
});
```

## Mutations

```graphql
// Before
type Mutation {
  createTask(data: TaskCreateInput): Task
  createTasks(data: [TasksCreateInput]): [Task]
  updateTask(id: ID!, data: TaskUpdateInput): Task
  updateTasks(data: [TasksUpdateInput]): [Task]
  deleteTask(id: ID!): Task
  deleteTasks(ids: [ID!]): [Task]
  ...
}

// After
type Mutation {
  createTask(data: TaskCreateInput!): Task
  createTasks(data: [TaskCreateInput!]!): [Task]
  updateTask(where: TaskWhereUniqueInput!, data: TaskUpdateInput!): Task
  updateTasks(data: [TaskUpdateArgs!]!): [Task]
  deleteTask(where: TaskWhereUniqueInput!): Task
  deleteTasks(where: [TaskWhereUniqueInput!]!): [Task]
  ...
}
```

- Inputs are non-nullable
- We use `where: ItemWhereUniqueInput!` and `where: [ItemWhereUniqueInput!]!` rather than `id: ID!` and `ids: [ID!].
- Create/update many no longer take a nested `{ data: ... }` input.

## Query

```graphql
// Before

type Query {
  allTasks(
    where: TaskWhereInput! = {}
    search: String
    sortBy: [SortTasksBy!]
      @deprecated(reason: "sortBy has been deprecated in favour of orderBy")
    orderBy: [TaskOrderByInput!]! = []
    first: Int
    skip: Int! = 0
  ): [Task!]
  Task(where: TaskWhereUniqueInput!): Task
  _allTasksMeta(
    where: TaskWhereInput! = {}
    search: String
    sortBy: [SortTasksBy!]
      @deprecated(reason: "sortBy has been deprecated in favour of orderBy")
    orderBy: [TaskOrderByInput!]! = []
    first: Int
    skip: Int! = 0
  ): _QueryMeta
    @deprecated(
      reason: "This query will be removed in a future version. Please use tasksCount instead."
    )
  tasksCount(where: TaskWhereInput! = {}): Int
  ...
}

// After
type Query {
  tasks(
    where: TaskWhereInput! = {}
    orderBy: [TaskOrderByInput!]! = []
    take: Int
    skip: Int! = 0
  ): [Task!]
  task(where: TaskWhereUniqueInput!): Task
  tasksCount(where: TaskWhereInput! = {}): Int
  ...
}
```

- The deprecated `_allItemsMeta` has been removed. Use `itemsCount`.
- The filter arguments `sortBy`, `search` and search have been removed.
- The filter argument `first` has been renamed to `take.
- The queries `allItems` and `Item` have been renamed to `items` and `item`.

## Filters

FIXME

## Types

```graphql
// Before

input TaskUpdateInput {
  label: String
  priority: TaskPriorityType
  isComplete: Boolean
  assignedTo: PersonRelateToOneInput
  finishBy: String
}

input TaskCreateInput {
  label: String
  priority: TaskPriorityType
  isComplete: Boolean
  assignedTo: PersonRelateToOneInput
  finishBy: String
}

input PersonRelateToOneInput {
  create: PersonCreateInput
  connect: PersonWhereUniqueInput
  disconnect: PersonWhereUniqueInput
  disconnectAll: Boolean
}

// After

input TaskUpdateInput {
  label: String
  priority: TaskPriorityType
  isComplete: Boolean
  assignedTo: PersonRelateToOneForUpdateInput
  finishBy: String
}

input TaskCreateInput {
  label: String
  priority: TaskPriorityType
  isComplete: Boolean
  assignedTo: PersonRelateToOneForCreateInput
  finishBy: String
}

input PersonRelateToOneForCreateInput {
  create: PersonCreateInput
  connect: PersonWhereUniqueInput
}

input PersonRelateToOneForUpdateInput {
  create: PersonCreateInput
  connect: PersonWhereUniqueInput
  disconnect: Boolean
}
```

 - To-one relationship inputs now have different types for `create` and `update`
 - Neither of these types support `disconnectAll`
 - The to-one relationship type for `create` does not support `disconnect`.
 - FIXME: Need to include a to-many example in here

export default ({ children, ...props }) => <Markdown description="A Fresh New GraphQL API" {...props}>{children}</Markdown>;
export { getServerSideProps }
